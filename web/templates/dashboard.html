{% extends "base.html" %}

{% block content %}
<div class="kpi-row kpi-row-2">
    <div class="kpi-card">
        <div class="kpi-icon kpi-icon-mercury">
            <img src="https://play-lh.googleusercontent.com/Dz9FjvMNDpuvUOsHsbUrbCPpDbkcyuUPa04o9ozdADTih2Gri6nH5aBg6sqsMLi8ZQ" alt="Mercury" width="36" height="36" style="border-radius:8px; filter:invert(1) brightness(2);">
        </div>
        <div class="kpi-info">
            <div class="kpi-label">Mercury Balance</div>
            <div class="kpi-value" id="kpi-mercury">—</div>
        </div>
    </div>
    <div class="kpi-card">
        <div class="kpi-icon">
            <img src="https://images.stripeassets.com/fzn2n1nzq965/HTTOloNPhisV9P4hlMPNA/cacf1bb88b9fc492dfad34378d844280/Stripe_icon_-_square.svg" alt="Stripe" width="36" height="36" style="border-radius:8px;">
        </div>
        <div class="kpi-info">
            <div class="kpi-label">Stripe Balance</div>
            <div class="kpi-value" id="kpi-stripe">—</div>
        </div>
    </div>
</div>
<div class="kpi-row kpi-row-3">
    <div class="kpi-card kpi-card-clickable" id="kpi-arr-card" onclick="loadArrHistory()">
        <div class="kpi-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                <polyline points="17 6 23 6 23 12"/>
            </svg>
        </div>
        <div class="kpi-info">
            <div class="kpi-label">Run Rate ARR</div>
            <div class="kpi-value" id="kpi-arr">—</div>
        </div>
    </div>
    <div class="kpi-card">
        <div class="kpi-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#3498db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
        </div>
        <div class="kpi-info">
            <div class="kpi-label">2026 Total Collected</div>
            <div class="kpi-value" id="kpi-ytd">—</div>
        </div>
    </div>
    <div class="kpi-card">
        <div class="kpi-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#e74c3c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 1l4 4-4 4"/>
                <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
                <path d="M7 23l-4-4 4-4"/>
                <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
            </svg>
        </div>
        <div class="kpi-info">
            <div class="kpi-label">2026 Owner Distributions</div>
            <div class="kpi-value" id="kpi-distributions">—</div>
        </div>
    </div>
    <div class="kpi-card">
        <div class="kpi-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#f39c12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/>
                <polyline points="17 18 23 18 23 12"/>
            </svg>
        </div>
        <div class="kpi-info">
            <div class="kpi-label">2026 Total Money Out</div>
            <div class="kpi-value" id="kpi-outflows">—</div>
        </div>
    </div>
</div>

<div class="chart-container">
    <div id="in-vs-out-chart" class="chart"></div>
</div>
<div class="chart-container">
    <div id="profit-margin-chart" class="chart-medium"></div>
</div>
<div class="chart-container">
    <div id="spend-by-category-chart" class="chart"></div>
</div>

<div class="chart-row">
    <div class="chart-container chart-half">
        <div id="revenue-by-client-chart" class="chart-fixed"></div>
    </div>
    <div class="chart-container chart-half">
        <div id="concentration-risk-chart" class="chart-fixed"></div>
    </div>
</div>

<div class="chart-container" style="position:relative;">
    <button id="remind-all-btn" class="btn-remind-all" onclick="remindAllOverdue()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
            <polyline points="22,6 12,13 2,6"/>
        </svg>
        <span>Remind All Overdue</span>
    </button>
    <div id="expected-revenue-chart" class="chart-fixed-tall"></div>
</div>

<div class="chart-container">
    <div id="days-to-pay-chart" class="chart-fixed"></div>
</div>

<!-- Spend detail drill-down modal -->
<div id="spend-detail-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <button class="modal-close" id="modal-close-btn">&times;</button>
        <div id="spend-detail-chart" style="width:100%;height:100%;"></div>
    </div>
</div>

<!-- Margin detail modal -->
<div id="margin-detail-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content modal-content-wide">
        <button class="modal-close" id="margin-modal-close-btn">&times;</button>
        <h2 class="modal-title">Profit Margin Breakdown</h2>
        <div class="invoice-table-container">
            <table class="invoice-table">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th class="text-right">Money In</th>
                        <th class="text-right">Money Out</th>
                        <th class="text-right">Net</th>
                        <th class="text-right">Margin</th>
                    </tr>
                </thead>
                <tbody id="margin-detail-body"></tbody>
                <tfoot id="margin-detail-foot"></tfoot>
            </table>
        </div>
    </div>
</div>

<!-- ARR history modal -->
<div id="arr-history-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content modal-content-wide">
        <button class="modal-close" id="arr-modal-close-btn">&times;</button>
        <h2 class="modal-title">Run Rate ARR History</h2>
        <div class="invoice-table-container">
            <table class="invoice-table">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th class="text-right">Monthly Collected</th>
                        <th class="text-right">Run Rate ARR</th>
                        <th class="text-right">MoM Change</th>
                    </tr>
                </thead>
                <tbody id="arr-history-body"></tbody>
                <tfoot id="arr-history-foot"></tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Invoice detail drill-down modal -->
<div id="invoice-detail-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content modal-content-wide">
        <button class="modal-close" id="invoice-modal-close-btn">&times;</button>
        <h2 id="invoice-modal-title" class="modal-title">Open Invoices</h2>
        <div id="invoice-table-container" class="invoice-table-container">
            <table class="invoice-table">
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Amount Due</th>
                        <th>Due Date</th>
                        <th>Status</th>
                        <th>Action</th>
                        <th>Last Reminded</th>
                    </tr>
                </thead>
                <tbody id="invoice-table-body"></tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('web.static', filename='js/dashboard.js') }}?v=6"></script>
{% endblock %}
